<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PostgreSQL Performance Analyzer | Fireweed DBT2</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      /* =================================================== */
      /* ===== PROFESSIONAL DASHBOARD / PGADMIN THEME ===== */
      /* =================================================== */

      :root {
        /* Color Palette */
        --bg-main: #f8f9fa;
        --bg-card: #ffffff;
        --border-color: #dee2e6;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --primary-blue: #0d6efd;
        --primary-blue-hover: #0b5ed7;
        --primary-blue-light: #e7f1ff;

        /* Typography */
        --font-family-sans-serif: system-ui, -apple-system, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif,
          'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol',
          'Noto Color Emoji';
      }

      /* --- Global Styles --- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-main);
        color: var(--text-primary);
        font-family: var(--font-family-sans-serif);
        font-size: 16px;
        line-height: 1.5;
        margin: 0;
      }

      /* --- Layout & Main Container --- */
      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
        display: grid;
        gap: 1.5rem;
      }

      .dashboard-card {
        background-color: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        padding: 1.5rem;
      }

      /* --- Header & Typography --- */
      h1 {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .description {
        color: var(--text-secondary);
        max-width: 80ch;
        margin-bottom: 1rem;
      }

      /* --- Filter Controls --- */
      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        align-items: end;
      }

      .filter-group label {
        display: block;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }

      select,
      button {
        width: 100%;
        font-family: inherit;
        font-size: 1rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }

      select:focus {
        border-color: var(--primary-blue);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
      }

      button {
        cursor: pointer;
        font-weight: 500;
      }

      .btn-primary {
        background-color: var(--primary-blue);
        color: #fff;
        border-color: var(--primary-blue);
      }
      .btn-primary:hover {
        background-color: var(--primary-blue-hover);
        border-color: var(--primary-blue-hover);
      }

      .btn-secondary {
        background-color: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-color);
      }
      .btn-secondary:hover {
        background-color: #f1f3f5;
      }

      .button-group {
        display: flex;
        gap: 0.75rem;
      }

      #branch-filter-container {
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 0.75rem;
        height: 120px;
        overflow-y: auto;
        background-color: #f8f9fa;
      }
      .branch-item {
        display: flex;
        align-items: center;
        padding: 0.25rem 0;
      }
      .branch-item label {
        margin: 0 0 0 0.5rem;
        font-weight: 400;
        font-size: 1rem;
        color: var(--text-primary);
        cursor: pointer;
      }
      input[type='checkbox'] {
        height: 1rem;
        width: 1rem;
        cursor: pointer;
      }

      /* --- D3 Chart Styles --- */
      .chart-container {
        position: relative;
      }

      .axis path,
      .axis line {
        stroke: var(--border-color);
        shape-rendering: crispEdges;
      }
      .axis text {
        fill: var(--text-secondary);
        font-family: var(--font-family-sans-serif);
        font-size: 12px;
      }
      .grid path {
        display: none;
      }
      .grid line {
        stroke: #e9ecef; /* Lighter than main border */
        stroke-dasharray: 2, 2;
      }
      .brush .selection {
        fill: var(--primary-blue);
        fill-opacity: 0.15;
        stroke: var(--primary-blue);
        stroke-opacity: 0.5;
      }
      .line {
        stroke-width: 2px;
      }
      circle {
        stroke-width: 2px;
        stroke: var(--bg-card);
      }

      /* --- Tooltip Styles --- */
      .tooltip {
        position: absolute;
        opacity: 0;
        background-color: var(--bg-card);
        color: var(--text-primary);
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: 1px solid var(--border-color);
        font-size: 0.875rem;
        line-height: 1.6;
        white-space: nowrap;
        transition: opacity 0.2s ease-in-out;
        z-index: 1000;
        min-width: 320px;
        pointer-events: none;
      }
      .tooltip-date {
        font-weight: 600;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
      }
      .tooltip .version-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
      }
      .tooltip .version-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .tooltip .version-name {
        flex-grow: 1;
        font-weight: 500;
        color: var(--text-secondary);
      }
      .tooltip .version-value {
        font-weight: 600;
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono',
          'Courier New', monospace;
      }
      .tooltip .commit-details {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
      }
      .tooltip .tooltip-label {
        color: var(--text-secondary);
        font-weight: 500;
      }
      .tooltip a {
        color: var(--primary-blue);
        text-decoration: none;
        pointer-events: auto;
        font-weight: 500;
      }
      .tooltip a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <div class="header">
        <h1>Fireweed DBT2 Performance Analyzer</h1>
        <p class="description">
          This dashboard visualizes historical performance metrics from the DBT2
          test suite. Use the controls to filter the data by test scale and
          development branch. The context chart below allows for time-range
          selection to zoom in on specific periods.
        </p>
      </div>

      <div class="dashboard-card">
        <div class="filter-grid">
          <div class="filter-group">
            <label for="scale-filter">Test Scale</label>
            <select id="scale-filter"></select>
          </div>
          <div class="filter-group">
            <label for="branch-filter-container">Development Branches</label>
            <div id="branch-filter-container"></div>
          </div>
          <div class="filter-group">
            <label> </label>
            <!-- Spacer for alignment -->
            <div class="button-group">
              <button id="apply-filters" class="btn-primary">
                Apply Filters
              </button>
              <button id="reset-filters" class="btn-secondary">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="dashboard-card chart-container">
        <svg width="100%" height="700"></svg>
        <div class="tooltip"></div>
      </div>
    </main>

    <script>
      // --- GLOBAL VARIABLES TO HOLD DATA ---
      let fullChartData = [];
      let currentChartData = [];

      document.addEventListener('DOMContentLoaded', () => {
        fetch('./fireweed.csv')
          .then((response) => {
            if (!response.ok)
              throw new Error(
                `Failed to load data: ${response.status} ${response.statusText}`
              );
            return response.text();
          })
          .then((csvText) => {
            const rawData = parseCSV(csvText);

            if (!rawData || !Array.isArray(rawData) || rawData.length === 0) {
              throw new Error('No valid data found in CSV file');
            }

            fullChartData = rawData
              .map((d) => ({
                branch: d.branch || 'unknown',
                revision: d.revision,
                scale: +d.scale,
                ctime: new Date(d.ctime * 1000),
                metric: +d.metric,
                commit_message: d.commit_message || 'N/A',
              }))
              .sort((a, b) => a.ctime - b.ctime);

            if (fullChartData.length === 0) {
              throw new Error('CSV file contains no processable data.');
            }

            initializeFilters(fullChartData);
            renderInitialChart();
          })
          .catch((error) => {
            console.error('Error during initialization:', error);
            const svg = d3.select('svg');
            svg
              .append('text')
              .attr('x', '50%')
              .attr('y', 50)
              .attr('text-anchor', 'middle')
              .attr('fill', '#dc3545')
              .style('font-size', '1.2rem')
              .text(`Error: ${error.message}`);
          });
      });

      // ===================================================================
      // ORIGINAL UNCHANGED FUNCTIONS
      // ===================================================================

      function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map((h) => h.trim());
        return lines.slice(1).map((line) => {
          const values = line
            .match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g)
            .map((v) => v.replace(/^"|"$/g, '').trim());
          const entry = {};
          headers.forEach((header, i) => {
            entry[header] = values[i] || '';
          });
          return entry;
        });
      }

      function initializeApp(fireweedData) {
        const svg = d3.select('svg');
        const width = svg.node().getBoundingClientRect().width;
        const height = +svg.attr('height');

        const margin = { top: 20, right: 30, bottom: 120, left: 60 };
        const chartHeight = height - margin.top - margin.bottom;
        const chartWidth = width - margin.left - margin.right;

        const xScale = d3
          .scaleTime()
          .domain(d3.extent(fireweedData, (d) => d.ctime))
          .range([0, chartWidth]);

        const yScale = d3
          .scaleLinear()
          .domain([
            d3.min(fireweedData, (d) => d.metric) * 0.95,
            d3.max(fireweedData, (d) => d.metric) * 1.05,
          ])
          .range([chartHeight, 0]);

        const branches = Array.from(new Set(fireweedData.map((d) => d.branch)));
        const colorScale = d3.scaleOrdinal(d3.schemeTableau10).domain(branches);

        svg
          .append('defs')
          .append('clipPath')
          .attr('id', 'chart-clip')
          .append('rect')
          .attr('width', chartWidth)
          .attr('height', chartHeight);

        const chart = svg
          .append('g')
          .attr('transform', `translate(${margin.left}, ${margin.top})`);

        const xAxis = d3
          .axisBottom(xScale)
          .ticks(width / 100)
          .tickFormat(d3.timeFormat('%b %d, ‘%y'));
        const yAxis = d3.axisLeft(yScale).ticks(8);
        const xGrid = d3
          .axisBottom(xScale)
          .tickSize(-chartHeight)
          .tickFormat('');
        const yGrid = d3.axisLeft(yScale).tickSize(-chartWidth).tickFormat('');

        chart
          .append('g')
          .attr('class', 'grid x-grid')
          .attr('transform', `translate(0, ${chartHeight})`)
          .call(xGrid);
        chart.append('g').attr('class', 'grid y-grid').call(yGrid);

        const xAxisGroup = chart
          .append('g')
          .attr('class', 'axis')
          .attr('transform', `translate(0, ${chartHeight})`)
          .call(xAxis);
        const yAxisGroup = chart.append('g').attr('class', 'axis').call(yAxis);

        const clipArea = chart
          .append('g')
          .attr('clip-path', 'url(#chart-clip)');

        const line = d3
          .line()
          .x((d) => xScale(d.ctime))
          .y((d) => yScale(d.metric));

        const groupedData = d3.group(fireweedData, (d) => d.branch);
        const branchLines = clipArea
          .append('g')
          .selectAll('.line')
          .data(groupedData)
          .join('path')
          .attr('class', 'line')
          .attr('fill', 'none')
          .attr('stroke', ([branch]) => colorScale(branch))
          .attr('d', ([, data]) => line(data));

        const branchCircles = clipArea
          .append('g')
          .selectAll('circle')
          .data(fireweedData)
          .join('circle')
          .attr('cx', (d) => xScale(d.ctime))
          .attr('cy', (d) => yScale(d.metric))
          .attr('r', 4.5)
          .attr('fill', (d) => colorScale(d.branch));

        const contextHeight = 60;
        const contextTop = chartHeight + 60;

        const contextGroup = svg
          .append('g')
          .attr('transform', `translate(${margin.left}, ${contextTop})`);

        const xScale2 = d3
          .scaleTime()
          .domain(xScale.domain())
          .range([0, chartWidth]);
        const yScale2 = d3
          .scaleLinear()
          .domain(yScale.domain())
          .range([contextHeight, 0]);

        const contextLine = d3
          .line()
          .x((d) => xScale2(d.ctime))
          .y((d) => yScale2(d.metric));

        contextGroup
          .selectAll('.context-line')
          .data(groupedData)
          .join('path')
          .attr('fill', 'none')
          .attr('stroke', ([branch]) => colorScale(branch))
          .attr('stroke-opacity', 0.7)
          .attr('stroke-width', 1.5)
          .attr('d', ([, data]) => contextLine(data));

        contextGroup
          .append('g')
          .attr('transform', `translate(0, ${contextHeight})`)
          .call(
            d3
              .axisBottom(xScale2)
              .ticks(width / 150)
              .tickFormat(d3.timeFormat('%Y'))
          );

        const brush = d3
          .brushX()
          .extent([
            [0, 0],
            [chartWidth, contextHeight],
          ])
          .on('end', brushed);

        contextGroup.append('g').attr('class', 'brush').call(brush);

        const tooltip = d3.select('.tooltip');
        const chartCard = d3.select('.chart-container').node();

        branchCircles
          .on('mouseover', function (event, d) {
            const [pointerX, pointerY] = d3.pointer(event, chartCard);

            tooltip
              .style('opacity', 1)
              .style('left', `${pointerX + 20}px`)
              .style('top', `${pointerY}px`).html(`
              <div class="tooltip-date">${d3.timeFormat('%A, %B %d, %Y')(
                d.ctime
              )}</div>
              <div class="version-item">
                <span class="version-color" style="background-color: ${colorScale(
                  d.branch
                )}"></span>
                <span class="version-name">${d.branch}</span>
                <span class="version-value">${d.metric.toFixed(2)}</span>
              </div>
              <div class="commit-details">
                <span class="tooltip-label">Revision: </span>
                <span>${d.revision.substring(0, 10)}</span><br>
                <a href="https://github.com/fireweed-home/db2/commit/${
                  d.revision
                }" target="_blank" rel="noopener noreferrer">View on GitHub →</a>
              </div>
            `);

            d3.select(this).attr('r', 6.5).raise();
          })
          .on('mouseout', function () {
            tooltip.style('opacity', 0);
            d3.select(this).attr('r', 4.5);
          });

        function brushed(event) {
          if (!event.selection) return;

          const [x0, x1] = event.selection.map(xScale2.invert);
          xScale.domain([x0, x1]);

          const filtered = fireweedData.filter(
            (d) => d.ctime >= x0 && d.ctime <= x1
          );
          const yMin =
            filtered.length > 0 ? d3.min(filtered, (d) => d.metric) * 0.95 : 0;
          const yMax =
            filtered.length > 0
              ? d3.max(filtered, (d) => d.metric) * 1.05
              : yScale.domain()[1];
          yScale.domain([yMin, yMax]);

          const t = svg.transition().duration(400).ease(d3.easeCubicInOut);

          xAxisGroup.transition(t).call(xAxis);
          yAxisGroup.transition(t).call(yAxis);
          chart.select('.x-grid').transition(t).call(xGrid.scale(xScale));
          chart.select('.y-grid').transition(t).call(yGrid.scale(yScale));

          branchLines.transition(t).attr('d', ([, data]) => line(data));

          branchCircles
            .transition(t)
            .attr('cx', (d) => xScale(d.ctime))
            .attr('cy', (d) => yScale(d.metric))
            .attr('opacity', (d) => (d.ctime >= x0 && d.ctime <= x1 ? 1 : 0));
        }
      }

      // ===================================================================
      // NEW JAVASCRIPT FOR FILTERS AND RESPONSIVENESS
      // ===================================================================

      function initializeFilters(data) {
        const scales = [...new Set(data.map((d) => d.scale))].sort(
          (a, b) => a - b
        );
        const scaleSelect = d3.select('#scale-filter');
        scaleSelect
          .selectAll('option')
          .data(scales)
          .join('option')
          .attr('value', (d) => d)
          .text((d) => d);

        const defaultScale = scales.includes(100) ? 100 : scales[0];
        scaleSelect.property('value', defaultScale);

        const branches = [...new Set(data.map((d) => d.branch))].sort();
        const branchContainer = d3.select('#branch-filter-container');

        branchContainer.html('');

        const branchItems = branchContainer
          .selectAll('.branch-item')
          .data(branches)
          .join('div')
          .attr('class', 'branch-item');

        branchItems
          .append('input')
          .attr('id', (d) => `branch-${d.replace(/[\s/]/g, '-')}`)
          .attr('type', 'checkbox')
          .attr('value', (d) => d)
          .property('checked', true);

        branchItems
          .append('label')
          .attr('for', (d) => `branch-${d.replace(/[\s/]/g, '-')}`)
          .text((d) => d);
      }

      function renderInitialChart() {
        const defaultScale = 100;
        const initialData = fullChartData.filter(
          (d) => d.scale === defaultScale
        );

        if (initialData.length === 0) {
          console.warn('No data for default scale (100). Chart may be empty.');
        }

        currentChartData = initialData;
        initializeApp(currentChartData);
      }

      function applyFilters() {
        const selectedScale = +d3.select('#scale-filter').property('value');
        const selectedBranches = [];
        d3.selectAll(
          '#branch-filter-container input[type="checkbox"]:checked'
        ).each(function () {
          selectedBranches.push(this.value);
        });

        const filteredData = fullChartData.filter(
          (d) =>
            d.scale === selectedScale && selectedBranches.includes(d.branch)
        );

        d3.select('svg').html('');

        if (filteredData.length === 0) {
          const svg = d3.select('svg');
          svg
            .append('text')
            .attr('x', '50%')
            .attr('y', '40%')
            .attr('text-anchor', 'middle')
            .attr(
              'fill',
              getComputedStyle(document.documentElement)
                .getPropertyValue('--text-secondary')
                .trim()
            )
            .style('font-size', '1.2rem')
            .text('No data matches the current filter criteria.');
          currentChartData = [];
          return;
        }

        currentChartData = filteredData;
        initializeApp(currentChartData);
      }

      function resetFilters() {
        d3.select('svg').html('');
        initializeFilters(fullChartData);
        renderInitialChart();
      }

      d3.select('#apply-filters').on('click', applyFilters);
      d3.select('#reset-filters').on('click', resetFilters);

      function handleResize() {
        if (currentChartData && currentChartData.length > 0) {
          d3.select('svg').html('');
          initializeApp(currentChartData);
        }
      }

      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(handleResize, 250);
      });
    </script>
  </body>
</html>
